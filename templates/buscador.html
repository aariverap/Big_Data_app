<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador - BigData</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .resultados-container { margin-top: 2rem; }
        .json-view {
            background: #f4f4f4;
            border: 1px solid #ccc;
            padding: .5rem;
            font-size: .8rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>

<div class="container mt-4">

    <h1 class="text-center mb-4">Buscador de documentos</h1>

    <!-- Formulario -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="formBuscar" onsubmit="buscar(event)">
                <div class="row">
                    <div class="col-md-10">
                        <label class="form-label">Texto a buscar</label>
                        <input type="text" class="form-control" id="textoBuscar" required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100 mt-4">Buscar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="div_cargando" style="display:none;" class="text-center">
        <div class="spinner-border"></div><p>Buscando...</p>
    </div>

    <div id="divResultados" style="display:none;">
        <h4>Resultados: <span id="totalResultados"></span></h4>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ID</th>
                    <th>Score</th>
                    <th>Índice</th>
                    <th>Contenido</th>
                </tr>
            </thead>
            <tbody id="tablaResultados"></tbody>
        </table>
    </div>

    <div id="divError" class="alert alert-danger mt-3" style="display:none;">
        <b>Error:</b> <span id="mensajeError"></span>
    </div>

</div>

<!-- Modal Detalle -->
<div class="modal fade" id="modalDetalle">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body" id="modalDetalleBody"></div>
            <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button></div>
        </div>
    </div>
</div>

<script>

function buscar(event) {
    event.preventDefault();

    document.getElementById("divResultados").style.display = "none";
    document.getElementById("divError").style.display = "none";
    document.getElementById("div_cargando").style.display = "block";

    fetch("/buscar-elastic", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            texto: document.getElementById("textoBuscar").value,
            campo: "texto_completo"
        })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById("div_cargando").style.display = "none";
        
        if (data.success)
            mostrarResultados(data);
        else
            mostrarError(data.error);
    })
    .catch(err => {
        mostrarError("Error en la búsqueda");
        document.getElementById("div_cargando").style.display = "none";
    });
}

let ultimaBusqueda = [];

function mostrarResultados(data) {

    ultimaBusqueda = data.resultados || [];

    document.getElementById("totalResultados").textContent = data.total;
    mostrarHits(ultimaBusqueda);

    document.getElementById("divResultados").style.display = "block";
}

function mostrarHits(hits) {

    const tabla = document.getElementById("tablaResultados");
    tabla.innerHTML = "";

    if (!hits.length) {
        tabla.innerHTML = '<tr><td colspan="5" class="text-center">No se encontraron resultados</td></tr>';
        return;
    }

    hits.forEach((h, i) => {

        const s = h._source || {};
        const txt = s.texto_completo || s.texto || s.contenido || JSON.stringify(s);
        const preview = txt.substring(0,200) + (txt.length>200 ? "..." : "");

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${h._id}</td>
            <td>${h._score?.toFixed(3) || "N/A"}</td>
            <td>${h._index}</td>
            <td>
                <div class="json-view">${preview}</div>
                <button class="btn btn-sm btn-link" onclick="mostrarDetalle(${i})" data-bs-toggle="modal" data-bs-target="#modalDetalle">
                    Ver completo
                </button>
            </td>
        `;

        tabla.appendChild(tr);
    });
}

function mostrarError(msg) {
    document.getElementById("mensajeError").textContent = msg;
    document.getElementById("divError").style.display = "block";
}

function mostrarDetalle(i) {
    const source = ultimaBusqueda[i]._source;
    document.getElementById("modalDetalleBody").innerHTML =
        `<pre class="json-view" style="max-height:500px;">${JSON.stringify(source, null, 2)}</pre>`;
}

</script>

</body>
</html>
